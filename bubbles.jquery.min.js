/*
*   jQuery Google Bubbles 
*   Copyright (c) 2010 timmy willison
*   MIT License
*/

;(function($){var bp,bubbles=function(){return new bp.init(arguments);};bp=bubbles.prototype={opts:{center:{lat:36.915,lng:-95.225},markers:[{lat:35.289,lng:-94.756,title:'woot',content:'<div class="iw-content"><p>Hello World!!</p></div>'}],markerIcon:'images/google-maps-icon.png',markerShadow:'images/google-maps-shadow.png',windowImage:'images/google-maps-infobox.png',closeImage:'images/google-maps-close.png',offsetVertical:-226,offsetHorizontal:-20,iwWidth:208,iwHeight:165},init:function(a){var args=Array.prototype.slice.call(a);this.mapEl=$(args.shift());this.opts.map=new google.maps.Map(this.mapEl[0],{zoom:4,scrollwheel:0,center:new google.maps.LatLng(this.opts.center.lat,this.opts.center.lng),mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControl:true,navigationControlOptions:{style:google.maps.NavigationControlStyle.ZOOM_PAN}});$.extend(this.opts,args[0]||{});this.setMarkers(this.opts.map,this.opts.markers);},setMarkers:function(map,markers){for(var i=0;i<markers.length;i++){this.attachInfo(map,markers[i]);}},attachInfo:function(map,marker){var map=this.opts.map,title=marker.title,icon=this.opts.markerIcon,shadow=this.opts.markerShadow,content=marker.content,mLatLng=new google.maps.LatLng(marker.lat,marker.lng),g_marker=new google.maps.Marker({position:mLatLng,map:map,title:title,icon:icon,shadow:shadow});var b=this.opts;google.maps.event.addListener(g_marker,'click',function(){var iBox=new infoBox({latlng:g_marker.getPosition(),map:map,content:content,offsetVertical:b.offsetVertical,offsetHorizontal:b.offsetHorizontal,height:b.iwHeight,width:b.iwWidth,windowImage:b.windowImage,closeImage:b.closeImage});});}};bp.init.prototype=bp;var infoBox=function(args){var ibox=this;google.maps.OverlayView.call(ibox);ibox.latlng=args.latlng;ibox.map=args.map;ibox.content=args.content;ibox.offsetVertical=args.offsetVertical;ibox.offsetHorizontal=args.offsetHorizontal;ibox.height=args.height;ibox.width=args.width;ibox.windowImage=args.windowImage;ibox.closeImage=args.closeImage;ibox.boundsChangedListener=google.maps.event.addListener(ibox.map,"bounds_changed",function(){return ibox.panMap.apply(ibox);});ibox.setMap(this.map);};infoBox.prototype=new google.maps.OverlayView();infoBox.prototype.createElement=function(){var box=this,panes=box.getPanes(),div=box.div_;if(!div){div=box.div_=$('<div/>').css({'border':'0 none','position':'absolute','background':'url('+box.windowImage+') no-repeat top left',width:this.width,height:this.height,'padding':'10px 20px 30px 20px'});var topDiv=$('<div/>').css({'textAlign':'right','marginBottom':'-5px'});var closeImg=$('<img/>').css({width:11,height:11,'cursor':'pointer'}).attr('src',box.closeImage).appendTo(topDiv);function removeInfoBox(ib){return function(){ib.setMap(null);};}
google.maps.event.addDomListener(closeImg[0],'click',removeInfoBox(this));topDiv.appendTo(div);$(box.content).appendTo(div);div.remove().appendTo(panes.floatPane);this.panMap();}else if(div.parentNode!=panes.floatPane){div.remove().appendTo(panes.floatPane);}};infoBox.prototype.panMap=function(){var map=this.map,bounds=map.getBounds();if(!bounds)return;var position=this.latlng;var iwWidth=this.width,iwHeight=this.height;var iwOffsetX=this.offsetHorizontal,iwOffsetY=this.offsetVertical;var padX=40,padY=40;var mapDiv=map.getDiv(),mapWidth=mapDiv.offsetWidth,mapHeight=mapDiv.offsetHeight,boundsSpan=bounds.toSpan(),longSpan=boundsSpan.lng(),latSpan=boundsSpan.lat(),degPixelX=longSpan/mapWidth,degPixelY=latSpan/mapHeight;var mapWestLng=bounds.getSouthWest().lng(),mapEastLng=bounds.getNorthEast().lng(),mapNorthLat=bounds.getNorthEast().lat(),mapSouthLat=bounds.getSouthWest().lat();var iwWestLng=position.lng()+(iwOffsetX-padX)*degPixelX,iwEastLng=position.lng()+(iwOffsetX+iwWidth+padX)*degPixelX,iwNorthLat=position.lat()-(iwOffsetY-padY)*degPixelY,iwSouthLat=position.lat()-(iwOffsetY+iwHeight+padY)*degPixelY;var shiftLng=(iwWestLng<mapWestLng?mapWestLng-iwWestLng:0)+
(iwEastLng>mapEastLng?mapEastLng-iwEastLng:0);var shiftLat=(iwNorthLat>mapNorthLat?mapNorthLat-iwNorthLat:0)+
(iwSouthLat<mapSouthLat?mapSouthLat-iwSouthLat:0);var center=map.getCenter();var centerX=center.lng()-shiftLng,centerY=center.lat()-shiftLat;map.setCenter(new google.maps.LatLng(centerY,centerX));google.maps.event.removeListener(this.boundsChangedListener);this.boundsChangedListener=null;};infoBox.prototype.draw=function(){this.createElement();var pixPosition=this.getProjection().fromLatLngToDivPixel(this.latlng);$(this.div_).css({width:this.width,left:(pixPosition.x+this.offsetHorizontal),height:this.height,top:(pixPosition.y+this.offsetVertical),'display':'block'});};infoBox.prototype.remove=function(){if(this.div_.size())div_=this.div_.detach();}
$.fn.bubbles=function(){var args=Array.prototype.slice.call(arguments);this.each(function(){args.unshift(this);bubbles.apply(null,args);});return this;};})(jQuery);